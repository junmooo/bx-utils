<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å›¾ç‰‡å‹ç¼©æµ‹è¯•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      padding: 40px;
    }
    
    h1 {
      color: #333;
      margin-bottom: 30px;
      text-align: center;
      font-size: 28px;
    }
    
    .upload-section {
      margin-bottom: 30px;
    }
    
    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }
    
    .file-input-wrapper input[type=file] {
      position: absolute;
      left: -9999px;
    }
    
    .file-input-label {
      display: block;
      padding: 20px;
      background: #f0f2f5;
      border: 2px dashed #667eea;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #667eea;
      font-weight: 500;
    }
    
    .file-input-label:hover {
      background: #e8ebf5;
      border-color: #764ba2;
    }
    
    .file-input-label.drag-over {
      background: #e8ebf5;
      border-color: #764ba2;
    }
    
    .results {
      display: none;
      margin-top: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }
    
    .results.show {
      display: block;
    }
    
    .result-item {
      margin-bottom: 20px;
      display: grid;
      grid-template-columns: 150px 1fr;
      gap: 15px;
      align-items: center;
    }
    
    .result-label {
      font-weight: 600;
      color: #333;
    }
    
    .result-value {
      padding: 10px 15px;
      background: white;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      color: #666;
    }
    
    .size-comparison {
      margin-top: 25px;
      padding-top: 25px;
      border-top: 2px solid #e0e0e0;
    }
    
    .comparison-bar {
      display: flex;
      gap: 15px;
      margin-top: 15px;
      align-items: center;
    }
    
    .bar {
      flex: 1;
      height: 40px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 500;
      font-size: 14px;
    }
    
    .bar-before {
      background: #ff6b6b;
    }
    
    .bar-after {
      background: #51cf66;
    }
    
    .compression-rate {
      margin-top: 20px;
      padding: 15px;
      background: #f0f9ff;
      border-left: 4px solid #1e90ff;
      border-radius: 6px;
      color: #0c5a8b;
      font-weight: 500;
    }
    
    .compression-rate.good {
      background: #f0fdf4;
      border-left-color: #51cf66;
      color: #166534;
    }
    
    .compression-rate.bad {
      background: #fef2f2;
      border-left-color: #ff6b6b;
      color: #7f1d1d;
    }
    
    .image-preview {
      margin-top: 25px;
      padding-top: 25px;
      border-top: 2px solid #e0e0e0;
    }
    
    .image-preview h3 {
      color: #333;
      margin-bottom: 15px;
      font-size: 16px;
    }
    
    .image-preview img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: #667eea;
      font-weight: 500;
    }
    
    .loading.show {
      display: block;
    }
    
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f0f2f5;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .error {
      display: none;
      padding: 15px;
      background: #fef2f2;
      border: 1px solid #fca5a5;
      border-radius: 6px;
      color: #b91c1c;
      margin-top: 15px;
    }
    
    .error.show {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ–¼ï¸ å›¾ç‰‡å‹ç¼©æµ‹è¯•å·¥å…·</h1>
    
    <div class="upload-section">
      <div class="file-input-wrapper" id="fileInputWrapper">
        <input type="file" id="fileInput" accept="image/*" />
        <label for="fileInput" class="file-input-label" id="fileInputLabel">
          ğŸ“ ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„<br/>
          <small style="font-weight: normal; font-size: 12px; margin-top: 5px; display: block;">æ”¯æŒ PNGã€JPG ç­‰æ ¼å¼</small>
        </label>
      </div>
      <div class="error" id="errorMsg"></div>
    </div>
    
    <div class="loading" id="loading">
      <span class="spinner"></span>
      æ­£åœ¨å‹ç¼©ä¸­...
    </div>
    
    <div class="results" id="results">
      <div class="result-item">
        <div class="result-label">åŸå§‹æ–‡ä»¶å:</div>
        <div class="result-value" id="originalName">-</div>
      </div>
      
      <div class="result-item">
        <div class="result-label">åŸå§‹å¤§å°:</div>
        <div class="result-value" id="originalSize">-</div>
      </div>
      
      <div class="result-item">
        <div class="result-label">å‹ç¼©åå¤§å°:</div>
        <div class="result-value" id="compressedSize">-</div>
      </div>
      
      <div class="size-comparison">
        <strong style="color: #333; display: block; margin-bottom: 10px;">ğŸ“Š å¤§å°å¯¹æ¯”</strong>
        <div class="comparison-bar">
          <div style="width: 80px; font-weight: 600; text-align: center; color: #666; font-size: 12px;">åŸå§‹</div>
          <div class="bar bar-before" id="barBefore"></div>
        </div>
        <div class="comparison-bar">
          <div style="width: 80px; font-weight: 600; text-align: center; color: #666; font-size: 12px;">å‹ç¼©å</div>
          <div class="bar bar-after" id="barAfter"></div>
        </div>
      </div>
      
      <div class="compression-rate" id="compressionRate"></div>
      
      <div class="image-preview">
        <h3>åŸå§‹å›¾ç‰‡é¢„è§ˆ:</h3>
        <img id="originalPreview" alt="åŸå§‹å›¾ç‰‡" />
      </div>
      
      <div class="image-preview">
        <h3>å‹ç¼©åå›¾ç‰‡é¢„è§ˆ:</h3>
        <img id="compressedPreview" alt="å‹ç¼©åå›¾ç‰‡" />
      </div>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const fileInputLabel = document.getElementById('fileInputLabel');
    const fileInputWrapper = document.getElementById('fileInputWrapper');
    const loading = document.getElementById('loading');
    const results = document.getElementById('results');
    const errorMsg = document.getElementById('errorMsg');
    
    // æ‹–æ‹½å¤„ç†
    fileInputWrapper.addEventListener('dragover', (e) => {
      e.preventDefault();
      fileInputLabel.classList.add('drag-over');
    });
    
    fileInputWrapper.addEventListener('dragleave', () => {
      fileInputLabel.classList.remove('drag-over');
    });
    
    fileInputWrapper.addEventListener('drop', (e) => {
      e.preventDefault();
      fileInputLabel.classList.remove('drag-over');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        fileInput.files = files;
        handleFileSelect();
      }
    });
    
    fileInput.addEventListener('change', handleFileSelect);
    
    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    async function compressImage(file, maxSize = 4) {
      return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        if (!ctx) {
          resolve(file);
          return;
        }

        const img = new Image();

        img.onload = () => {
          let { width, height } = img;
          const maxWidth = 2560;
          const maxHeight = 2560;

          if (width > maxWidth || height > maxHeight) {
            const ratio = Math.min(maxWidth / width, maxHeight / height);
            width = width * ratio;
            height = height * ratio;
          }

          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);

          const compress = (quality = 0.8) => {
            const mimeType = file.type === 'image/png' ? 'image/jpeg' : file.type;
            
            canvas.toBlob(
              (blob) => {
                if (!blob) {
                  resolve(file);
                  return;
                }

                const size = blob.size / 1024 / 1024;

                if (size <= maxSize || quality <= 0.1) {
                  const fileName = file.name.replace(/\.png$/i, '.jpg');
                  const compressedFile = new File([blob], fileName, {
                    type: mimeType,
                    lastModified: Date.now(),
                  });
                  resolve(compressedFile);
                } else {
                  compress(quality - 0.1);
                }
              },
              mimeType,
              quality,
            );
          };

          compress();
        };

        img.onerror = () => {
          resolve(file);
        };

        img.src = URL.createObjectURL(file);
      });
    }
    
    async function handleFileSelect() {
      const file = fileInput.files[0];
      if (!file) return;
      
      errorMsg.classList.remove('show');
      results.classList.remove('show');
      loading.classList.add('show');
      
      try {
        if (!file.type.startsWith('image/')) {
          throw new Error('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
        }
        
        const originalSize = file.size;
        const compressedFile = await compressImage(file);
        const compressedSize = compressedFile.size;
        
        const compressionRate = ((1 - compressedSize / originalSize) * 100).toFixed(2);
        const maxSize = Math.max(originalSize, compressedSize);
        
        document.getElementById('originalName').textContent = file.name;
        document.getElementById('originalSize').textContent = formatBytes(originalSize);
        document.getElementById('compressedSize').textContent = formatBytes(compressedSize);
        
        document.getElementById('barBefore').textContent = formatBytes(originalSize);
        document.getElementById('barBefore').style.width = (originalSize / maxSize * 100) + '%';
        
        document.getElementById('barAfter').textContent = formatBytes(compressedSize);
        document.getElementById('barAfter').style.width = (compressedSize / maxSize * 100) + '%';
        
        const compressionRateEl = document.getElementById('compressionRate');
        const isGood = compressionRate > 0;
        compressionRateEl.className = isGood ? 'compression-rate good' : 'compression-rate bad';
        
        if (isGood) {
          compressionRateEl.textContent = `âœ… å‹ç¼©æˆåŠŸï¼å‹ç¼©ç‡ï¼š${compressionRate}%ï¼ˆå‡å°‘äº† ${formatBytes(originalSize - compressedSize)}ï¼‰`;
        } else {
          compressionRateEl.textContent = `âš ï¸ æ–‡ä»¶å¢å¤§äº† ${(-compressionRate).toFixed(2)}%ï¼ˆå¢åŠ äº† ${formatBytes(compressedSize - originalSize)}ï¼‰`;
        }
        
        // æ˜¾ç¤ºåŸå§‹å›¾ç‰‡
        const originalURL = URL.createObjectURL(file);
        document.getElementById('originalPreview').src = originalURL;
        
        // æ˜¾ç¤ºå‹ç¼©åçš„å›¾ç‰‡
        const compressedURL = URL.createObjectURL(compressedFile);
        document.getElementById('compressedPreview').src = compressedURL;
        
        results.classList.add('show');
      } catch (error) {
        errorMsg.classList.add('show');
        errorMsg.textContent = 'âŒ é”™è¯¯ï¼š' + error.message;
      } finally {
        loading.classList.remove('show');
      }
    }
  </script>
</body>
</html>
